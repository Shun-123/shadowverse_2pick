{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>デッキ分析</h2>
    <p>現在のデッキ構成を分析し、改善提案を提供します。</p>
    
    <form method="POST">
        <div class="form-group">
            <label for="deck_input">デッキ内容 (カード名またはIDをカンマ区切り):</label>
            <textarea id="deck_input" name="deck_input" rows="8" required
                      placeholder="例: 不屈のファイター, ベルエンジェル・リア, 刹那のクイックブレイダー, 10101110, ..."></textarea>
            <small style="color: #666;">カード名またはIDを入力してください。30枚まで分析できます。</small>
        </div>
        
        <button type="submit" class="btn">デッキを分析</button>
    </form>
</div>

{% if error_message %}
<div class="alert alert-error">{{ error_message }}</div>
{% endif %}

{% if analysis_result %}
<div class="card">
    <h3>📊 デッキ分析結果</h3>
    
    <!-- 基本情報 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
        <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: var(--primary);">{{ analysis_result.total_cards }}</div>
            <div>総カード数</div>
        </div>
        <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: var(--primary);">{{ analysis_result.avg_rating }}</div>
            <div>平均評価</div>
        </div>
        <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: var(--primary);">{{ analysis_result.strength_assessment.tier }}</div>
            <div>デッキ強度</div>
        </div>
    </div>
    
    <div class="alert alert-info">
        <strong>{{ analysis_result.strength_assessment.description }}</strong>
        (調整後評価: {{ analysis_result.strength_assessment.adjusted_rating }})
    </div>
    
    <!-- マナカーブ -->
    <h4>📈 マナカーブ</h4>
    <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        {% for cost in range(1, 8) %}
            {% set count = analysis_result.curve.get(cost, 0) %}
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <span style="width: 60px;">{{ cost }}コスト:</span>
                <div style="background: var(--primary); height: 20px; width: {{ count * 20 }}px; margin-right: 0.5rem; border-radius: 4px;"></div>
                <span>{{ count }}枚</span>
            </div>
        {% endfor %}
    </div>
    
    <!-- 役割分布 -->
    {% if analysis_result.roles %}
    <h4>⚔️ 役割分布</h4>
    <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        {% for role, count in analysis_result.roles.items() %}
        <span style="display: inline-block; background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; margin: 0.25rem; font-size: 0.9em;">
            {{ role }}: {{ count }}枚
        </span>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- クラス分布 -->
    {% if analysis_result.class_distribution %}
    <h4>🎯 クラス分布</h4>
    <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        {% for class_name, count in analysis_result.class_distribution.items() %}
        <span style="display: inline-block; background: var(--secondary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; margin: 0.25rem; font-size: 0.9em;">
            {{ class_name }}: {{ count }}枚
        </span>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- 改善提案 -->
    {% if analysis_result.recommendations %}
    <h4>💡 改善提案</h4>
    <ul style="margin: 1rem 0; padding-left: 2rem;">
        {% for recommendation in analysis_result.recommendations %}
        <li style="margin: 0.5rem 0;">{{ recommendation }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    
    <!-- シナジー分析セクション -->
    {% if analysis_result.synergy_analysis %}
    <h4>🔗 シナジー分析</h4>
    <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        <div style="margin-bottom: 0.5rem;">
            <strong>総合シナジースコア: {{ analysis_result.synergy_analysis.synergy_score }}</strong>
        </div>
        {% if analysis_result.synergy_analysis.synergies %}
            {% for synergy_name, synergy_data in analysis_result.synergy_analysis.synergies.items() %}
            <div style="margin: 0.5rem 0;">
                <span style="display: inline-block; background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; margin-right: 0.5rem;">
                    {{ synergy_name }}
                </span>
                <small>基盤: {{ synergy_data.enablers }}枚, 活用: {{ synergy_data.payoffs }}枚</small>
            </div>
            {% endfor %}
        {% else %}
            <p>検出されたシナジーはありませんでした。</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- アーキタイプ分析セクション -->
    {% if analysis_result.archetype_analysis %}
    <h4>🎯 アーキタイプ分析</h4>
    <div class="alert alert-info">
        {% if analysis_result.archetype_analysis.detected_archetype %}
        <strong>検出: {{ analysis_result.archetype_analysis.detected_archetype }}</strong>
        （信頼度: {{ analysis_result.archetype_analysis.confidence }}%）<br>
        {{ analysis_result.archetype_analysis.get('archetype_description', '') }}
        {% else %}
        明確なアーキタイプが検出されませんでした。バランス型デッキを目指しましょう。
        {% endif %}
    </div>

    {% if analysis_result.archetype_analysis.recommendations %}
    <h5>戦略的推奨事項:</h5>
    <ul style="margin: 1rem 0; padding-left: 2rem;">
        {% for recommendation in analysis_result.archetype_analysis.recommendations %}
        <li style="margin: 0.5rem 0;">{{ recommendation }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endif %}

    
    <!-- 解決できなかったカード -->
    {% if analysis_result.unresolved_cards %}
    <div class="alert alert-warning">
        <strong>解決できなかったカード:</strong> {{ ', '.join(analysis_result.unresolved_cards) }}
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}
