{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>2Pickアドバイス</h2>
    <p>カード名またはIDで入力できます。入力中に候補が表示されます。</p>
    
    <form method="POST">
        <div class="form-group">
            <label for="candidate1">候補カード1:</label>
            <input type="text" id="candidate1" name="candidate1" required 
                   placeholder="例: 二刀のゴブリン または 10201110">
        </div>
        
        <div class="form-group">
            <label for="candidate2">候補カード2:</label>
            <input type="text" id="candidate2" name="candidate2" required 
                   placeholder="例: アドベンチャーエルフ・メイ または 10012110">
        </div>
        
        <div class="form-group">
            <label for="deck_input">現在のデッキ (カード名またはIDをカンマ区切り):</label>
            <textarea id="deck_input" name="deck_input" rows="3" 
                      placeholder="例: 不屈のファイター, ベルエンジェル・リア, 10101110"></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <div class="form-group" style="flex: 1;">
                <label for="pick_index">ピック番号:</label>
                <input type="number" id="pick_index" name="pick_index" value="1" min="1" max="15">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="rerolls_left">残りリロール:</label>
                <input type="number" id="rerolls_left" name="rerolls_left" value="2" min="0" max="5">
            </div>
        </div>
        
        <button type="submit" class="btn">アドバイスを取得</button>
    </form>
</div>

{% if error_message %}
<div class="alert alert-error">{{ error_message }}</div>
{% endif %}

{% if advice_result %}
<div class="card">
    <h3>📋 アドバイス結果</h3>
    
    <div style="font-size: 1.2em; margin: 1rem 0; padding: 1rem; background: #f0f8ff; border-radius: 8px;">
        <strong>推奨: {{ advice_result.action_text }}</strong>
        <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; margin-left: 1rem; font-size: 0.9em;">
            信頼度: {{ advice_result.confidence }}%
        </span>
    </div>
    
    {% if advice_result.deck_info %}
    <div class="alert alert-info">{{ advice_result.deck_info }}</div>
    {% endif %}
    
    <h4>推奨理由:</h4>
    <ul style="margin: 1rem 0; padding-left: 2rem;">
        {% for reason in advice_result.reasoning %}
        <li style="margin: 0.5rem 0;">{{ reason }}</li>
        {% endfor %}
    </ul>
    
    <h4>各カードの評価:</h4>
    <div style="overflow-x: auto;">
        <table>
            <tr>
                <th>カード名</th><th>コスト</th><th>最終スコア</th>
                <th>基本</th><th>カーブ</th><th>役割</th><th>シナジー</th><th>戦略</th><th>メタ</th><th>重複</th>
            </tr>
            {% for score in advice_result.card_scores %}
            <tr>
                <td><strong>{{ score.name }}</strong></td>
                <td>{{ score.cost }}</td>
                <td style="font-weight: bold; color: var(--primary);">{{ '%.1f' % score.final_score }}</td>
                <td>{{ '%.1f' % score.base_score }}</td>
                <td style="color: {{ '#48bb78' if score.curve_bonus >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.curve_bonus if score.curve_bonus >= 0 else '%.1f' % score.curve_bonus }}
                </td>
                <td style="color: {{ '#48bb78' if score.role_bonus >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.role_bonus if score.role_bonus >= 0 else '%.1f' % score.role_bonus }}
                </td>
                <td style="color: {{ '#48bb78' if score.get('synergy_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('synergy_bonus', 0) if score.get('synergy_bonus', 0) >= 0 else '%.1f' % score.get('synergy_bonus', 0) }}
                    {% if score.get('synergy_reasons') and score.synergy_reasons|length > 0 %}
                        <br><small style="color: #666;">{{ score.synergy_reasons[0] }}</small>
                    {% endif %}
                </td>
                <td style="color: {{ '#48bb78' if score.get('archetype_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('archetype_bonus', 0) if score.get('archetype_bonus', 0) >= 0 else '%.1f' % score.get('archetype_bonus', 0) }}
                </td>
                <td style="color: {{ '#48bb78' if score.get('meta_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('meta_bonus', 0) if score.get('meta_bonus', 0) >= 0 else '%.1f' % score.get('meta_bonus', 0) }}
                </td>
                <td style="color: {{ '#48bb78' if score.duplication_penalty >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.duplication_penalty if score.duplication_penalty >= 0 else '%.1f' % score.duplication_penalty }}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- 既存の評価テーブルの下に追加 -->
    {% if advice_result %}
    <div class="card" style="margin-top: 1rem; background: #f0f8ff;">
        <h4>📝 実際の選択を記録（任意）</h4>
        <p>実際に選んだカードを記録することで、アドバイザーの精度向上に貢献できます。</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 1rem; align-items: end;">
            <div class="form-group">
                <label for="actual_action">実際のアクション:</label>
                <select id="actual_action">
                    <option value="pick">カードを選択</option>
                    <option value="reroll">リロール</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="chosen_card">選んだカード:</label>
                <select id="chosen_card">
                    {% for score in advice_result.card_scores %}
                    <option value="{{ score.card_id }}">{{ score.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn" onclick="logPick()" style="background: var(--success);">
                    選択を記録
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="session_id">セッションID（任意）:</label>
            <input type="text" id="session_id" placeholder="例: my_draft_001">
            <small style="color: #666;">同じドラフトセッションでは同じIDを使用してください</small>
        </div>
    </div>

    <script>
    function logPick() {
        const sessionId = document.getElementById('session_id').value || 
                         `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const action = document.getElementById('actual_action').value;
        const chosenId = document.getElementById('chosen_card').value;
        
        const pickIndex = parseInt(document.getElementById('pick_index').value) || 1;
        const rerollsLeft = parseInt(document.getElementById('rerolls_left').value) || 0;
        
        const scores = {{ advice_result.card_scores | tojson if advice_result else '[]' }};
        const candidateIds = scores.map(s => s.card_id);
        const recommendedId = "{{ advice_result.advice.recommended_card_id if advice_result and advice_result.advice.recommended_card_id else '' }}";
        
        const deckInput = document.getElementById('deck_input').value || '';
        const deckSnapshot = deckInput.split(',').map(s => s.trim()).filter(Boolean);
        
        fetch('/api/log_pick', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                pick_index: pickIndex,
                rerolls_left: rerollsLeft,
                candidate1_id: candidateIds[0] || null,
                candidate2_id: candidateIds[1] || null,
                recommended_id: recommendedId || null,
                chosen_id: action === 'pick' ? chosenId : null,
                action: action,
                scores: scores,
                deck_snapshot: deckSnapshot
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('選択を記録しました！継続的な改善にご協力ありがとうございます。');
                // セッションIDを保存
                localStorage.setItem('sv2pick_session_id', sessionId);
            } else {
                alert('記録に失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました');
        });
    }

    // ページ読み込み時にセッションIDを復元
    document.addEventListener('DOMContentLoaded', function() {
        const savedSessionId = localStorage.getItem('sv2pick_session_id');
        if (savedSessionId) {
            document.getElementById('session_id').value = savedSessionId;
        }
    });
    </script>
    {% endif %}


    <!-- メタ情報表示を追加 -->
    <div class="alert alert-info" style="margin-top: 1rem;">
        <strong>現在のメタ環境:</strong> {{ advisor.meta_info.meta_description if advisor.meta_info else '標準環境' }}
        <br><small>最終更新: {{ advisor.meta_info.last_updated if advisor.meta_info else '未設定' }}</small>
    </div>



</div>
{% endif %}
{% endblock %}
