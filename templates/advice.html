{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>2Pickã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
    <p>ã‚«ãƒ¼ãƒ‰åã¾ãŸã¯IDã§å…¥åŠ›ã§ãã¾ã™ã€‚å…¥åŠ›ä¸­ã«å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    
    <form method="POST">
        <div class="form-group">
            <label for="candidate1">å€™è£œã‚«ãƒ¼ãƒ‰1:</label>
            <input type="text" id="candidate1" name="candidate1" required 
                   placeholder="ä¾‹: äºŒåˆ€ã®ã‚´ãƒ–ãƒªãƒ³ ã¾ãŸã¯ 10201110">
        </div>
        
        <div class="form-group">
            <label for="candidate2">å€™è£œã‚«ãƒ¼ãƒ‰2:</label>
            <input type="text" id="candidate2" name="candidate2" required 
                   placeholder="ä¾‹: ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã‚¨ãƒ«ãƒ•ãƒ»ãƒ¡ã‚¤ ã¾ãŸã¯ 10012110">
        </div>
        
        <div class="form-group">
            <label for="deck_input">ç¾åœ¨ã®ãƒ‡ãƒƒã‚­ (ã‚«ãƒ¼ãƒ‰åã¾ãŸã¯IDã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):</label>
            <textarea id="deck_input" name="deck_input" rows="3" 
                      placeholder="ä¾‹: ä¸å±ˆã®ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼, ãƒ™ãƒ«ã‚¨ãƒ³ã‚¸ã‚§ãƒ«ãƒ»ãƒªã‚¢, 10101110"></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <div class="form-group" style="flex: 1;">
                <label for="pick_index">ãƒ”ãƒƒã‚¯ç•ªå·:</label>
                <input type="number" id="pick_index" name="pick_index" value="1" min="1" max="15">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="rerolls_left">æ®‹ã‚Šãƒªãƒ­ãƒ¼ãƒ«:</label>
                <input type="number" id="rerolls_left" name="rerolls_left" value="2" min="0" max="5">
            </div>
        </div>
        
        <button type="submit" class="btn">ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—</button>
    </form>
</div>

{% if error_message %}
<div class="alert alert-error">{{ error_message }}</div>
{% endif %}

{% if advice_result %}
<div class="card">
    <h3>ğŸ“‹ ã‚¢ãƒ‰ãƒã‚¤ã‚¹çµæœ</h3>
    
    <div style="font-size: 1.2em; margin: 1rem 0; padding: 1rem; background: #f0f8ff; border-radius: 8px;">
        <strong>æ¨å¥¨: {{ advice_result.action_text }}</strong>
        <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; margin-left: 1rem; font-size: 0.9em;">
            ä¿¡é ¼åº¦: {{ advice_result.confidence }}%
        </span>
    </div>
    
    {% if advice_result.deck_info %}
    <div class="alert alert-info">{{ advice_result.deck_info }}</div>
    {% endif %}
    
    <h4>æ¨å¥¨ç†ç”±:</h4>
    <ul style="margin: 1rem 0; padding-left: 2rem;">
        {% for reason in advice_result.reasoning %}
        <li style="margin: 0.5rem 0;">{{ reason }}</li>
        {% endfor %}
    </ul>
    
    <h4>å„ã‚«ãƒ¼ãƒ‰ã®è©•ä¾¡:</h4>
    <div style="overflow-x: auto;">
        <table>
            <tr>
                <th>ã‚«ãƒ¼ãƒ‰å</th><th>ã‚³ã‚¹ãƒˆ</th><th>æœ€çµ‚ã‚¹ã‚³ã‚¢</th>
                <th>åŸºæœ¬</th><th>ã‚«ãƒ¼ãƒ–</th><th>å½¹å‰²</th><th>ã‚·ãƒŠã‚¸ãƒ¼</th><th>æˆ¦ç•¥</th><th>ãƒ¡ã‚¿</th><th>é‡è¤‡</th>
            </tr>
            {% for score in advice_result.card_scores %}
            <tr>
                <td><strong>{{ score.name }}</strong></td>
                <td>{{ score.cost }}</td>
                <td style="font-weight: bold; color: var(--primary);">{{ '%.1f' % score.final_score }}</td>
                <td>{{ '%.1f' % score.base_score }}</td>
                <td style="color: {{ '#48bb78' if score.curve_bonus >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.curve_bonus if score.curve_bonus >= 0 else '%.1f' % score.curve_bonus }}
                </td>
                <td style="color: {{ '#48bb78' if score.role_bonus >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.role_bonus if score.role_bonus >= 0 else '%.1f' % score.role_bonus }}
                </td>
                <td style="color: {{ '#48bb78' if score.get('synergy_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('synergy_bonus', 0) if score.get('synergy_bonus', 0) >= 0 else '%.1f' % score.get('synergy_bonus', 0) }}
                    {% if score.get('synergy_reasons') and score.synergy_reasons|length > 0 %}
                        <br><small style="color: #666;">{{ score.synergy_reasons[0] }}</small>
                    {% endif %}
                </td>
                <td style="color: {{ '#48bb78' if score.get('archetype_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('archetype_bonus', 0) if score.get('archetype_bonus', 0) >= 0 else '%.1f' % score.get('archetype_bonus', 0) }}
                </td>
                <td style="color: {{ '#48bb78' if score.get('meta_bonus', 0) >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.get('meta_bonus', 0) if score.get('meta_bonus', 0) >= 0 else '%.1f' % score.get('meta_bonus', 0) }}
                </td>
                <td style="color: {{ '#48bb78' if score.duplication_penalty >= 0 else '#f56565' }};">
                    {{ '+%.1f' % score.duplication_penalty if score.duplication_penalty >= 0 else '%.1f' % score.duplication_penalty }}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- æ—¢å­˜ã®è©•ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸‹ã«è¿½åŠ  -->
    {% if advice_result %}
    <div class="card" style="margin-top: 1rem; background: #f0f8ff;">
        <h4>ğŸ“ å®Ÿéš›ã®é¸æŠã‚’è¨˜éŒ²ï¼ˆä»»æ„ï¼‰</h4>
        <p>å®Ÿéš›ã«é¸ã‚“ã ã‚«ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã®ç²¾åº¦å‘ä¸Šã«è²¢çŒ®ã§ãã¾ã™ã€‚</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 1rem; align-items: end;">
            <div class="form-group">
                <label for="actual_action">å®Ÿéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</label>
                <select id="actual_action">
                    <option value="pick">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</option>
                    <option value="reroll">ãƒªãƒ­ãƒ¼ãƒ«</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="chosen_card">é¸ã‚“ã ã‚«ãƒ¼ãƒ‰:</label>
                <select id="chosen_card">
                    {% for score in advice_result.card_scores %}
                    <option value="{{ score.card_id }}">{{ score.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn" onclick="logPick()" style="background: var(--success);">
                    é¸æŠã‚’è¨˜éŒ²
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="session_id">ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä»»æ„ï¼‰:</label>
            <input type="text" id="session_id" placeholder="ä¾‹: my_draft_001">
            <small style="color: #666;">åŒã˜ãƒ‰ãƒ©ãƒ•ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯åŒã˜IDã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</small>
        </div>
    </div>

    <script>
    function logPick() {
        const sessionId = document.getElementById('session_id').value || 
                         `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const action = document.getElementById('actual_action').value;
        const chosenId = document.getElementById('chosen_card').value;
        
        const pickIndex = parseInt(document.getElementById('pick_index').value) || 1;
        const rerollsLeft = parseInt(document.getElementById('rerolls_left').value) || 0;
        
        const scores = {{ advice_result.card_scores | tojson if advice_result else '[]' }};
        const candidateIds = scores.map(s => s.card_id);
        const recommendedId = "{{ advice_result.advice.recommended_card_id if advice_result and advice_result.advice.recommended_card_id else '' }}";
        
        const deckInput = document.getElementById('deck_input').value || '';
        const deckSnapshot = deckInput.split(',').map(s => s.trim()).filter(Boolean);
        
        fetch('/api/log_pick', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                pick_index: pickIndex,
                rerolls_left: rerollsLeft,
                candidate1_id: candidateIds[0] || null,
                candidate2_id: candidateIds[1] || null,
                recommended_id: recommendedId || null,
                chosen_id: action === 'pick' ? chosenId : null,
                action: action,
                scores: scores,
                deck_snapshot: deckSnapshot
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('é¸æŠã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ç¶™ç¶šçš„ãªæ”¹å–„ã«ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä¿å­˜
                localStorage.setItem('sv2pick_session_id', sessionId);
            } else {
                alert('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å¾©å…ƒ
    document.addEventListener('DOMContentLoaded', function() {
        const savedSessionId = localStorage.getItem('sv2pick_session_id');
        if (savedSessionId) {
            document.getElementById('session_id').value = savedSessionId;
        }
    });
    </script>
    {% endif %}


    <!-- ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤ºã‚’è¿½åŠ  -->
    <div class="alert alert-info" style="margin-top: 1rem;">
        <strong>ç¾åœ¨ã®ãƒ¡ã‚¿ç’°å¢ƒ:</strong> {{ advisor.meta_info.meta_description if advisor.meta_info else 'æ¨™æº–ç’°å¢ƒ' }}
        <br><small>æœ€çµ‚æ›´æ–°: {{ advisor.meta_info.last_updated if advisor.meta_info else 'æœªè¨­å®š' }}</small>
    </div>



</div>
{% endif %}
{% endblock %}
